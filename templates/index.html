
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Segmentation</title>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    />
    <style>
      body {
        background-color: #eff2f9;
      }
      .img-container,
      .result-container {
        text-align: center;
        margin-top: 20px;
      }
      .image-preview,
      .result-preview {
        border: 2px solid #1b2d6b;
        width: 300px;
        height: 300px;
        display: inline-block;
      }
      #photo,
      .segmented-image {
        width: 100%;
        height: 100%;
        display: none;
      }
      .loader {
        display: none;
        border: 8px solid #f3f3f3;
        border-top: 8px solid #363e75;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 2s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h3 class="text-center py-4">Image Segmentation</h3>

      <div class="img-container">
        <div class="image-preview">
          <img id="photo" src="" alt="Uploaded Image" />
        </div>
      </div>

      <div class="text-center mt-3">
        <input type="file" id="fileinput" hidden />
        <button class="btn btn-primary" id="upload-btn">Upload Image</button>
        <button class="btn btn-success" id="predict-btn">Segment</button>
      </div>

      <div class="loader mx-auto mt-3" id="loading"></div>

      <div class="result-container">
        <h5 class="mt-3">Segmented Output</h5>
        <div class="result-preview">
          <img
            class="segmented-image"
            id="seg-result"
            src=""
            alt="Segmented Image"
          />
        </div>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>
      let base_data = "";

      function sendRequest(base64Data) {
        if (!base64Data) return alert("Please upload an image first!");

        $("#loading").show();
        $.ajax({
          url: "http://127.0.0.1:8080/predict",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({ image: base64Data }),
          success: function (res) {
            $("#loading").hide();
            if (res.result_image) {
              $("#seg-result")
                .attr("src", "data:image/jpeg;base64," + res.result_image)
                .show();
            } else {
              alert("Error processing image.");
            }
          },
          error: function () {
            $("#loading").hide();
            alert("Failed to connect to the server.");
          },
        });
      }

      $("#upload-btn").click(() => $("#fileinput").trigger("click"));

      $("#fileinput").change(function () {
        if (this.files && this.files[0]) {
          let reader = new FileReader();
          reader.onload = function (e) {
            let img = new Image();
            img.onload = function () {
              let canvas = document.createElement("canvas");
              canvas.width = img.width;
              canvas.height = img.height;
              let ctx = canvas.getContext("2d");
              ctx.drawImage(img, 0, 0);
              base_data = canvas.toDataURL("image/jpeg", 1.0).split(",")[1];
            };
            img.src = e.target.result;
            $("#photo").attr("src", e.target.result).show();
          };
          reader.readAsDataURL(this.files[0]);
        }
      });

      $("#predict-btn").click(() => sendRequest(base_data));
    </script>
  </body>
</html>
